<!-- Loading Overlay -->
<app-loading-overlay [stage]="webContainer.stage()" />

<!-- Problem Selector (shown when no problem is loaded) -->
@if (!assessment.currentProblem() && webContainer.stage() === 'idle') {
  <div class="problem-selector d-flex align-items-center justify-content-center vh-100">
    <div class="card shadow-lg" style="max-width: 600px; width: 90%;">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">
          <i class="bi bi-code-square me-2"></i>
          Angular Skill Assessment
        </h4>
      </div>
      <div class="card-body">
        <p class="text-muted">Select a problem to begin your assessment. Your code will compile and run in the browser using a real Angular environment.</p>
        <div class="list-group">
          @for (problem of problems; track problem.id) {
            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    (click)="startAssessment(problem.id)"
                    [disabled]="isLoading()">
              <div>
                <h6 class="mb-1">{{ problem.title }}</h6>
                <small class="text-muted">
                  {{ Math.floor(problem.timeLimit / 60) }} min |
                  {{ problem.maxScore }} pts |
                  {{ problem.starterFiles.length }} files
                </small>
              </div>
              <i class="bi bi-chevron-right"></i>
            </button>
          }
        </div>
      </div>
      @if (errorMessage()) {
        <div class="card-footer">
          <div class="alert alert-danger mb-0">
            <i class="bi bi-exclamation-triangle me-1"></i>
            {{ errorMessage() }}
          </div>
        </div>
      }
      <div class="card-footer bg-light">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>
          Requires Chrome or Edge. The environment takes 15-30s to boot.
        </small>
      </div>
    </div>
  </div>
}

<!-- Submission Result -->
@if (assessment.isSubmitted()) {
  <div class="submission-overlay">
    <div class="card shadow-lg text-center" style="max-width: 500px; width: 90%;">
      <div class="card-body p-4">
        @if (assessment.finalScore(); as score) {
          <div class="mb-3">
            @if (score.passed === score.total && score.total > 0) {
              <i class="bi bi-trophy-fill text-warning" style="font-size: 4rem;"></i>
            } @else {
              <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
            }
          </div>
          <h2>Assessment Submitted!</h2>
          <div class="display-4 fw-bold my-3"
               [class.text-success]="score.passed === score.total"
               [class.text-warning]="score.passed > 0 && score.passed < score.total"
               [class.text-danger]="score.passed === 0 && score.total > 0">
            {{ score.score }} / {{ assessment.currentProblem()?.maxScore }} pts
          </div>
          <p class="text-muted">{{ score.passed }} of {{ score.total }} tests passed</p>
          <div class="progress mb-3" style="height: 10px;">
            <div class="progress-bar bg-success" [style.width.%]="score.total > 0 ? (score.passed / score.total) * 100 : 0"></div>
          </div>
          <button class="btn btn-primary" (click)="backToProblems()">
            <i class="bi bi-arrow-left me-1"></i> Back to Problems
          </button>
        }
      </div>
    </div>
  </div>
}

<!-- Main Workspace -->
@if (assessment.currentProblem() && !assessment.isSubmitted()) {
  <div class="workspace-layout vh-100 d-flex flex-column">
    <!-- Top: Header with tabs, timer, theme -->
    <app-workspace-header
      [isDarkTheme]="isDarkTheme()"
      (themeToggle)="toggleTheme()" />

    <!-- Middle: Main content (sidebar + editor) -->
    <div class="main-row flex-grow-1 d-flex overflow-hidden">
      <!-- Left Sidebar: Problem + File Tree -->
      <div class="sidebar d-flex flex-column" [style.width.px]="sidebarWidth()">
        <!-- Sidebar tabs -->
        <div class="sidebar-tabs d-flex">
          <button class="sidebar-tab" [class.active]="sidebarTab() === 'problem'"
                  (click)="sidebarTab.set('problem')">
            <i class="bi bi-book me-1"></i> Problem
          </button>
          <button class="sidebar-tab" [class.active]="sidebarTab() === 'files'"
                  (click)="sidebarTab.set('files')">
            <i class="bi bi-folder2-open me-1"></i> Files
          </button>
        </div>
        <div class="sidebar-content flex-grow-1 overflow-hidden">
          @if (sidebarTab() === 'problem') {
            <app-problem-panel />
          } @else {
            <app-file-tree />
          }
        </div>
      </div>

      <!-- Sidebar resize handle -->
      <div class="resize-handle-v" (mousedown)="startSidebarDrag($event)"></div>

      <!-- Right: Code Editor -->
      <div class="editor-area flex-grow-1 d-flex flex-column overflow-hidden">
        <app-code-editor [theme]="isDarkTheme() ? 'vs-dark' : 'vs'" />
      </div>
    </div>

    <!-- Bottom Panel resize handle -->
    <div class="resize-handle-h" (mousedown)="startBottomDrag($event)"></div>

    <!-- Bottom: Tabbed Panel (Console / Preview / Tests) -->
    <div class="bottom-panel d-flex flex-column" [style.height.px]="bottomPanelHeight()">
      <div class="bottom-tabs d-flex align-items-center">
        <button class="bottom-tab" [class.active]="bottomTab() === 'terminal'"
                (click)="bottomTab.set('terminal')">
          <i class="bi bi-terminal me-1"></i> Terminal
          @if (webContainer.serverOutput().length > 0) {
            <span class="activity-dot"></span>
          }
        </button>
        <button class="bottom-tab" [class.active]="bottomTab() === 'console'"
                (click)="bottomTab.set('console')">
          <i class="bi bi-journal-code me-1"></i> Console
          @if (appConsole.count() > 0) {
            <span class="badge bg-secondary ms-1" style="font-size: 9px;">{{ appConsole.count() }}</span>
          }
          @if (appConsole.errorCount() > 0) {
            <span class="badge bg-danger ms-1" style="font-size: 9px;">{{ appConsole.errorCount() }}</span>
          }
        </button>
        <button class="bottom-tab" [class.active]="bottomTab() === 'preview'"
                (click)="bottomTab.set('preview')">
          <i class="bi bi-eye me-1"></i> Preview
          @if (webContainer.previewUrl()) {
            <span class="badge bg-success ms-1" style="font-size: 9px;">Live</span>
          }
        </button>
        <button class="bottom-tab" [class.active]="bottomTab() === 'tests'"
                (click)="bottomTab.set('tests')">
          <i class="bi bi-check2-square me-1"></i> Tests
        </button>
        <button class="bottom-tab" [class.active]="bottomTab() === 'errors'"
                (click)="bottomTab.set('errors')">
          <i class="bi bi-exclamation-triangle me-1"></i> Problems
          @if (compilation.hasErrors()) {
            <span class="badge bg-danger ms-1" style="font-size: 9px;">{{ compilation.errors().length }}</span>
          }
        </button>

        <!-- Right side: collapse/expand -->
        <div class="ms-auto d-flex align-items-center gap-1 pe-2">
          <button class="bottom-tab-btn" (click)="toggleBottomPanel()" title="Toggle panel">
            <i [class]="bottomPanelHeight() > 50 ? 'bi bi-chevron-down' : 'bi bi-chevron-up'"></i>
          </button>
        </div>
      </div>
      <div class="bottom-content flex-grow-1 overflow-hidden">
        @switch (bottomTab()) {
          @case ('terminal') { <app-console-output /> }
          @case ('console') { <app-app-console /> }
          @case ('preview') { <app-preview-panel /> }
          @case ('tests') { <app-test-results-panel /> }
          @case ('errors') {
            <div class="errors-panel p-2">
              @if (compilation.errors().length === 0) {
                <div class="text-center text-muted py-3">
                  <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                  <p class="mt-2 mb-0">No problems detected</p>
                </div>
              } @else {
                @for (error of compilation.errors(); track $index) {
                  <div class="error-row d-flex align-items-start p-2 mb-1">
                    <i class="bi bi-x-circle-fill text-danger me-2 mt-1"></i>
                    <div>
                      <code class="text-warning">{{ error.file }}:{{ error.line }}:{{ error.column }}</code>
                      <span class="ms-2 text-light">{{ error.message }}</span>
                    </div>
                  </div>
                }
              }
            </div>
          }
        }
      </div>
    </div>

    <!-- Bottom Toolbar -->
    <app-toolbar
      (runTests)="onRunTests()"
      (resetCode)="onReset()"
      (submit)="onSubmit()" />
  </div>
}
